<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="google-adsense-account" content="ca-pub-3650229640310116">
  <title>Community | LearnComputers</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      --bg:#0a0f1f; --accent:#00aaff; --card-bg:rgba(255,255,255,0.08);
      --text:#fff; --glow:0 0 20px rgba(0,170,255,0.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Inter',system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;color:var(--text);
      background:radial-gradient(circle at top left,#101935,#060a14);overflow-x:hidden;}

    nav{
      position:fixed; top:0; left:0; width:100%;
      background:rgba(10,15,30,0.7); backdrop-filter:blur(20px);
      display:flex; justify-content:space-between; align-items:center;
      padding:15px 7%; z-index:1000; box-shadow:0 0 20px rgba(0,0,0,0.5);
    }
    nav .logo{font-size:1.6rem; font-weight:700; color:var(--accent)}
    nav ul{list-style:none; display:flex; gap:25px; margin:0; padding:0}
    nav ul li a{ text-decoration:none; color:#ccc; font-weight:500; transition:0.25s; font-size:1rem}
    nav ul li a:hover, nav ul li a.active{ color:var(--accent) }
    .nav-actions{display:flex; gap:10px; align-items:center}
    .login-btn{
      background:var(--accent); color:#fff; padding:8px 18px; border-radius:12px; font-weight:600; text-decoration:none;
      box-shadow:var(--glow);
    }

    .community { padding:140px 10% 80px; max-width:1100px; margin:0 auto; }
    .page-title { text-align:center; color:var(--accent); font-size:2.8rem; margin-bottom:8px; }
    .page-sub { text-align:center; color:#b0c4de; margin-bottom:28px; }

    .top-row { display:flex; align-items:center; justify-content:space-between; gap:20px; margin-bottom:18px }
    #addPostBtn {
      width:56px; height:56px; border-radius:50%; border:none; background:var(--accent); color:white; font-size:28px;
      display:inline-flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:var(--glow);
    }
    #addPostBtn.disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

    select#topicFilter {
      padding:10px 16px; border-radius:10px; border:none;
      background:#fff; color:#000; font-weight:600; cursor:pointer;
    }

    #postsContainer{ margin-top:18px; display:flex; flex-direction:column; gap:18px }
    .post-card{
      background:var(--card-bg); border: 1px solid rgba(255,255,255,0.1); border-radius:14px; padding:20px;
      cursor:pointer; transition: 0.2s;
    }
    .post-card:hover { border-color: var(--accent); transform: translateY(-3px); }
    .post-meta { display:flex; gap:12px; font-size:0.85rem; color:#b8cfe9; margin-bottom:8px }
    .post-title { color:var(--accent); font-size:1.2rem; margin:6px 0; font-weight:700 }
    .post-body { color:#dbeaff; opacity: 0.9; }

    .post-modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.85); z-index:2200; padding: 20px; }
    .post-modal .card { width:100%; max-width:800px; max-height:90vh; overflow:auto; background:#fff; color:#000; border-radius:12px; padding:30px; position: relative; }
    .modal-close { position: absolute; top: 15px; right: 20px; cursor:pointer; font-size:24px; color:#666; }

    .replies { margin-top:25px; border-top:1px solid #eee; padding-top:20px }
    .reply { background:#f0f4f8; padding:12px; border-radius:8px; margin-top:10px; }
    .reply-author { font-weight:700; color:#0077cc; }
    .reply-area { margin-top:20px; display:flex; flex-direction:column; gap:10px }
    .reply-area textarea { padding:12px; border-radius:8px; border:1px solid #ddd; min-height:80px; }
    .reply-area button { background:var(--accent); color:#fff; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:700; }

    footer{ text-align:center; padding:40px; color:#666; }
  </style>
</head>
<body>

  <nav>
    <div class="logo">ðŸ’» Learn<span style="color:#fff;">Computers</span></div>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="community.html" class="active">Community</a></li>
      <li><a href="chatbot.html">AI Chat</a></li>
    </ul>
    <div class="nav-actions">
      <a href="login.html" class="login-btn" id="navAuthBtn">Login</a>
    </div>
  </nav>

  <main class="community">
    <div class="page-title">ðŸ’¬ Community</div>
    <div class="page-sub">Ask questions and share knowledge.</div>

    <div class="top-row">
      <div style="display:flex; align-items:center; gap:15px;">
        <button id="addPostBtn">+</button>
        <span id="loginNotice" style="color:#ff8888; font-size:0.9rem;">Login to post</span>
      </div>
      <select id="topicFilter">
        <option value="All">All Topics</option>
        <option>Programming</option>
        <option>Hardware</option>
        <option>AI</option>
        <option>Cybersecurity</option>
        <option>Other</option>
      </select>
    </div>

    <div id="postsContainer">
      <div style="text-align:center; padding:40px;">Loading discussions...</div>
    </div>
  </main>

  <div id="postModal" class="post-modal">
    <div class="card">
      <span id="closeModal" class="modal-close">âœ•</span>
      <h2 id="modalTitle" style="margin-top:0; color:#0077cc;"></h2>
      <p id="modalMeta" style="color:#666; font-size:0.9rem;"></p>
      <div id="modalBody" style="line-height:1.6; font-size:1.1rem; margin-bottom:20px;"></div>

      <div class="replies">
        <h3>Comments (<span id="replyCount">0</span>)</h3>
        <div id="repliesList"></div>
        <div id="replyArea" class="reply-area">
          <textarea id="replyText" placeholder="Write a comment..."></textarea>
          <button id="replyBtn">Post Comment</button>
        </div>
      </div>
    </div>
  </div>

  <footer>Â© 2025 LearnComputers</footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // 1. Initialize Firebase
    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // 2. Auth Handling (Rule 3)
    let user = null;
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth error:", err);
      }
    };
    initAuth();

    onAuthStateChanged(auth, (u) => {
      user = u;
      const addBtn = document.getElementById('addPostBtn');
      const notice = document.getElementById('loginNotice');
      const navBtn = document.getElementById('navAuthBtn');
      const replyArea = document.getElementById('replyArea');

      if (u && !u.isAnonymous) {
        addBtn.classList.remove('disabled');
        notice.style.display = 'none';
        navBtn.textContent = 'Profile';
        replyArea.style.display = 'flex';
      } else {
        addBtn.classList.add('disabled');
        notice.style.display = 'inline';
        replyArea.style.display = 'none';
      }
    });

    // 3. Firestore Collection Path (Rule 1)
    const postsCol = collection(db, 'artifacts', appId, 'public', 'data', 'posts');

    // 4. Data Loading
    let posts = [];
    let currentPostId = null;

    onSnapshot(postsCol, (snapshot) => {
      posts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      // Simple sort in memory (Rule 2)
      posts.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
      renderPosts();
    }, (err) => {
      console.error("Firestore Listen Error:", err);
      document.getElementById('postsContainer').innerHTML = `<p style="color:red; text-align:center;">Error loading posts. Please check Firebase rules.</p>`;
    });

    function renderPosts() {
      const container = document.getElementById('postsContainer');
      const filter = document.getElementById('topicFilter').value;
      const filtered = filter === 'All' ? posts : posts.filter(p => p.topic === filter);

      if (filtered.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#666;">No posts yet. Be the first!</p>';
        return;
      }

      container.innerHTML = '';
      filtered.forEach(p => {
        const div = document.createElement('div');
        div.className = 'post-card';
        div.onclick = () => openPost(p.id);
        div.innerHTML = `
          <div class="post-meta">
            <span>${p.topic || 'General'}</span> â€¢ 
            <span>By ${p.author || 'Member'}</span>
          </div>
          <div class="post-title">${p.title}</div>
          <div class="post-body">${p.text.substring(0, 100)}${p.text.length > 100 ? '...' : ''}</div>
        `;
        container.appendChild(div);
      });
    }

    // 5. Post & Reply Interaction
    document.getElementById('addPostBtn').onclick = async () => {
      if (!user || user.isAnonymous) {
        Swal.fire('Login Required', 'Please login to create a discussion.', 'info');
        return;
      }

      const { value: formValues } = await Swal.fire({
        title: 'New Discussion',
        html:
          `<input id="swal-title" class="swal2-input" placeholder="Title">` +
          `<textarea id="swal-text" class="swal2-textarea" placeholder="What's on your mind?"></textarea>`,
        showCancelButton: true,
        preConfirm: () => {
          const title = document.getElementById('swal-title').value;
          const text = document.getElementById('swal-text').value;
          if (!title || !text) return Swal.showValidationMessage('Fill all fields');
          return { title, text };
        }
      });

      if (formValues) {
        await addDoc(postsCol, {
          ...formValues,
          topic: document.getElementById('topicFilter').value === 'All' ? 'General' : document.getElementById('topicFilter').value,
          author: user.displayName || 'Member',
          authorId: user.uid,
          createdAt: serverTimestamp()
        });
      }
    };

    function openPost(id) {
      currentPostId = id;
      const post = posts.find(p => p.id === id);
      if (!post) return;

      document.getElementById('modalTitle').textContent = post.title;
      document.getElementById('modalBody').textContent = post.text;
      document.getElementById('modalMeta').textContent = `By ${post.author} in ${post.topic}`;
      document.getElementById('postModal').style.display = 'flex';

      // Load replies (Rule 1: subcollection path)
      const repliesCol = collection(db, 'artifacts', appId, 'public', 'data', 'posts', id, 'replies');
      onSnapshot(repliesCol, (snap) => {
        if (currentPostId !== id) return;
        const replies = snap.docs.map(d => d.data());
        replies.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
        
        document.getElementById('replyCount').textContent = replies.length;
        const list = document.getElementById('repliesList');
        list.innerHTML = '';
        replies.forEach(r => {
          const div = document.createElement('div');
          div.className = 'reply';
          div.innerHTML = `<div class="reply-author">${r.author}</div><div>${r.text}</div>`;
          list.appendChild(div);
        });
      }, (err) => console.error("Reply Error:", err));
    }

    document.getElementById('replyBtn').onclick = async () => {
      const text = document.getElementById('replyText').value.trim();
      if (!text || !currentPostId || !user) return;

      const repliesCol = collection(db, 'artifacts', appId, 'public', 'data', 'posts', currentPostId, 'replies');
      await addDoc(repliesCol, {
        text,
        author: user.displayName || 'Member',
        authorId: user.uid,
        createdAt: serverTimestamp()
      });
      document.getElementById('replyText').value = '';
    };

    document.getElementById('closeModal').onclick = () => document.getElementById('postModal').style.display = 'none';
    document.getElementById('topicFilter').onchange = renderPosts;
  </script>
</body>
</html>